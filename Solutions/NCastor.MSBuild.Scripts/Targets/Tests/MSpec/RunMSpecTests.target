<?xml version="1.0" encoding="utf-8" ?>

<Project DefaultTargets="All" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RunMSpecTestsDependsOn>
      SettingMSpecTestingAssemblies;
      CleanMSpecArtefactFolders;
      CreateMSpecArtefactFolders;
      BeforeRunMSpecTests;
      CoreRunMSpecTests;
      AfterRunMSpecTests;
      TransformMSpecXmlReporttToJUnitXmlReport;
    </RunMSpecTestsDependsOn>
  </PropertyGroup>

  <Target Name="RunMSpecTests" DependsOnTargets="$(RunMSpecTestsDependsOn)"/>

  <!-- To be overriden by the user -->
  <Target Name="BeforeRunMSpecTests" />
  <Target Name="AfterRunMSpecTests" />

  <Target Name="CoreRunMSpecTests" >

    <Error ContinueOnError="false" Text="The MSpec assemblies were not specified" Condition="@(MSpecAssemblies) == ''" />
    <Error ContinueOnError="false" Text="The MSpec xml report file was not specified" Condition="$(MSpecXmlReportFilePath) == ''" />
    <Error ContinueOnError="false" Text="The MSpec html report file was not specied" Condition="$(MSpecHtmlReporthFilePath) == ''" />
    <Error ContinueOnError="false" Text="The MSpec runner was not found in the tools path specified" Condition="!Exists($(MSPecRunner))" />
    <Error ContinueOnError="false" Text="The MSpec test assembly was not found: &quot;%(MSpecAssemblies.Identity)&quot;" Condition="!Exists(%(MSpecAssemblies.Identity))" />

    <ItemGroup>
      <_MSpecAssemblies Include="@(MSpecAssemblies->'&quot;%(Identity)&quot;')" />
    </ItemGroup>
    
    <PropertyGroup>
      <_MSpecOptions> --xml "$(MSpecXmlReportFilePath)" --html "$(MSpecHtmlReporthFilePath)"</_MSpecOptions>
      <_MSpecCommand>"$(MSPecRunner)" $(_MSpecOptions) @(_MSpecAssemblies, ' ')</_MSpecCommand>
    </PropertyGroup>

    <Exec Command="$(_MSpecCommand)" />
    
  </Target>  
  
</Project>
