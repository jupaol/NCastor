<?xml version="1.0" encoding="utf-8"?>

<Project DefaultTargets="BuildNCastorAutoBuilderSolution" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- TODO: Place your custom targets here -->
  <Target Name="CoreGetBuildVersion" DependsOnTargets="GetBuildVersionFromHudson;" />
  <Target Name="CoreGetExtraInformationalVersion" DependsOnTargets="FormatGitRevisionVersion" />

  <Target Name="CoreSettingInstrumentationAssemblies">
    <ItemGroup>
      <AssembliesToInstrument Include="
                                        $(TestAssembliesPath)\NCastor.AutoBuilder.Console.exe;" />
    </ItemGroup>
  </Target>

  <Target Name="CoreSettingMSTestTestingAssemblies">
    <ItemGroup>
      <MSTestContainers Include="
                          $(TestAssembliesPath)\NCastor.AutoBuilder.Console.Tests.dll;
                          $(TestAssembliesPath)\NCastor.AutoBuilder.Console.Integration.Tests.dll;" />
    </ItemGroup>
  </Target>

  <Target Name="CoreCustomizeMSTestWithOpenCoverArguments" >
    <Message Text="$(LoggingMessagePrefix) Setting up MSTest and OpenCover arguments..." Importance="high" />
    <PropertyGroup>
      <MSTestRunnerWithOpenCoverArguments>@(_MSTestContainersToRunCodeCoverage, ' ') /detail:errormessage /detail:errorstacktrace /detail:stderr /resultsfile:\"$(MSTestReportFilePath)\"</MSTestRunnerWithOpenCoverArguments>
      <_OpenCoverMSTestCommand>-target:"$(MSTestRunner)"  -targetargs:"$(MSTestRunnerWithOpenCoverArguments)"</_OpenCoverMSTestCommand>
      <OpenCoverRunnerArgumentsForMSTest>-targetdir:&quot;$(TestAssembliesPath)&quot; -mergebyhash -register -returntargetcode -filter:&quot;@(_AssembliesToInstrumentWithOpenCoverMSTest, ' ') -[NCastor.AutoBuilder.Console]*Constants&quot; -output:&quot;$(OpenCoverMSTest_ReportFilePath)&quot; $(_OpenCoverMSTestCommand)</OpenCoverRunnerArgumentsForMSTest>
    </PropertyGroup>
  </Target>

  <Target Name="CorePrepareNugetPackages">

    <ItemGroup>
      <_UnnecessaryNugetFiles Include="$(NCastorAutoBuilderConsole)\*.pdb;$(NCastorAutoBuilderConsole)\*.xml" />
    </ItemGroup>
    <Delete Files="@(_UnnecessaryNugetFiles)" />

    <ItemGroup>
      <_NCastorAutoBuilderConsoleNugetFiles
        Include="$(NCastorAutoBuilderConsole)\*.*"
        Exclude="$(NCastorAutoBuilderConsole)\*.md;$(NCastorAutoBuilderConsole)\*.nuspec;"/>
    </ItemGroup>

    <MakeDir Directories="$(NCastorAutoBuilderConsole)\Content\Tools\ConsoleRunner" />
    <Move
      DestinationFolder="$(NCastorAutoBuilderConsole)\Content\Tools\ConsoleRunner"
      SourceFiles="@(_NCastorAutoBuilderConsoleNugetFiles)"/>

    <ItemGroup>
      <NugetPackages Include="NCastor.AutoBuilder.Console.nuspec">
        <SourcePath>$(NCastorAutoBuilderConsole)</SourcePath>
        <ExtraOptions></ExtraOptions>
        <Version>$(SemanticVersion)</Version>
      </NugetPackages>
    </ItemGroup>

  </Target>

  <Target Name="CorePrepareSpecialProjects">

    <PropertyGroup>
      <NCastorAutoBuilderConsole>$(WorkingDirectoryPath)\NCastorAutoBuilderConsole</NCastorAutoBuilderConsole>
    </PropertyGroup>

    <ItemGroup>
      <SpecialProjects Include="$(SolutionsPath)\NCastor.AutoBuilder.Console\NCastor.AutoBuilder.Console\NCastor.AutoBuilder.Console.csproj">
        <WorkingDirectoryPath>$(NCastorAutoBuilderConsole)</WorkingDirectoryPath>
      </SpecialProjects>
    </ItemGroup>

  </Target>

  <Target Name="PrepareDistributeArtifacts">

    <PropertyGroup>
      <_PrivateNugetServerPath>c:\00\nuget</_PrivateNugetServerPath>
    </PropertyGroup>

    <ItemGroup>
      <DistributeArtifactFiles
        Include="$(DropsPath)\NCastor.AutoBuilder.*.nupkg">
        <OutputPath>$(_PrivateNugetServerPath)</OutputPath>
      </DistributeArtifactFiles>
    </ItemGroup>

  </Target>

</Project>
